#!{{ lookPath "python3" }}

# crossos alias for qemu

{{ if eq .chezmoi.os "linux" }}
from subprocess import run
from sys import argv

image = argv[1]
other_params = argv[2:]

format_voc = {}
format = "vpc"

accel = ["-enable-kvm"]
resources = ["-smp", 4, "-m", "4G"]
bios = ["-bios", "/usr/share/ovmf/OVMF.fd"]
drive = ["-drive", f"file={image},format={format},index=0,media=disk"]
port_fwd = ["-nic", "hostfwd=tcp:127.0.0.1:9922-0.0.0.0:22,hostfwd=tcp:127.0.0.1:9980-0.0.0.0:80"]

command = ["qemu-system-x86_64"] + accel + resources + bios + drive + port_fwd + other_params
run(command)
{{ end }}

{{ if eq .chezmoi.os "windows" }}
#--accel whpx
{{ end }}

{{ if eq .chezmoi.os "darwin" }}
{{ end }}

# TODO
# [ ] take arguments
#   - imagename
#   - (optional) image type
# [ ] run the command for linux with portforwarding and using kvm using hardware accelerator
# [ ] run the command for windows with portforwarding and using hyper as hardware accelerator
# [ ] irnore macos for a while

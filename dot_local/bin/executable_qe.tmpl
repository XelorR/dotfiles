#!{{ lookPath "python3" }}

# crossos alias for qemu

import re
from platform import architecture, system
from subprocess import run
from sys import argv
from multiprocessing import cpu_count
from psutil import virtual_memory

if len(argv) < 2:
    print("Usage: qe image.ext (qemu additional args)\n\n", "You should pass an image!")
    exit()
elif len(argv) == 2:
    image = argv[1]
    other_params = []
else:
    image = argv[1]
    other_params = argv[2:]

mem = int(virtual_memory()[0] / 1024 / 1024 / 1024 * 0.4)
cpus = int(cpu_count() * 0.4)
resources = ["-smp", cpus, "-m", f"{mem}G"]

if image.endswith(".iso"):
    drive = ["-cdrom", image, "-boot", "d"]
else:
    formats = {
        "qcow2": "qcow2",
        "qed": "qed",
        "raw ": "raw ",
        "vdi": "vdi",
        "vhd": "vpc ",
        "vmdk": "vmdk",
        "vdi.vtoy": "vdi",
        "vhd.vtoy": "vpc ",
    }
    format = formats[image.split(".")[-1]]
    drive = ["-drive", f"file={image},format={format},index=0,media=disk"]

port_fwd = ["-nic", "hostfwd=tcp:127.0.0.1:9922-0.0.0.0:22,hostfwd=tcp:127.0.0.1:9980-0.0.0.0:80"]
fat_folder = []

archs = {
    "64bit": "x86_64",
}
arch = archs[architecture()[0]]
# TODO detect on mac m1

os_family = system().lower()
if os_family == "linux":
    accel = ["-enable-kvm"]
    bios = ["-bios", "/usr/share/ovmf/OVMF.fd"]
elif os_family == "windows":
    accel = ["--accel", "whpx"]
    bios = []
elif os_family == "darwin":
    raise NotImplementedError
else:
    raise NotImplementedError

command = [f"qemu-system-{arch}"] + accel + resources + bios + fat_folder + drive + port_fwd + other_params

print(command)
run(command)
